<!DOCTYPE html>
<html>
	<link rel="stylesheet" type="text/css" href="../styles/popup.css">
    <head>
        <meta charset="utf8">
        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
        <script>
			var catalogRule;
			var catalogs;
			var $catalogs = {};
			var catalogsLoaded = 0;
			$(document).ready(function(){			
				var xhr = new XMLHttpRequest();
				xhr.addEventListener("load", degreeHandler);
				xhr.open("GET", "../scripts/degreePrograms.php");
				xhr.send();
				
				$("#catalogList").change(function(){
					$("#courseList").detach();
					$catalogs[$(this).val()].insertAfter($("#classListLabel"));
				});
				
				$("#addClassButton").click(function(){
					$("#classsublist").append($("<li>",{
						text: $("#courseList option:selected").val()
					}).append($("<input>",{
						type: "submit",
						name: "removeClassButton",
						value: "Remove"
					})));
				});
            });
            
			function degreeHandler() {
				console.log(this.response);
				var degreePrograms = JSON.parse(this.response);

				// Iterate through all degree programs and add to DOM as list item 
				for(var degreeName in degreePrograms) {
					$("#masters").append($("<li>", {
						value: degreeName
					}).append($("<label>", {
						text: degreeName
					}))); 

					// Create nested list under each degree program with the options offered, e.g., Thesis 
					var degreeOptions = $("<ul id='sublist'>");
					
					degreeOptions.append($("<li>", {
						name: "catalog"
					}).append($("<a>", {
						href: "addremove.html",
						text: "Edit Course Catalog",
						onclick: "document.cookie = 'program=" + degreeName + "'"
					})));
					
					for(var degreeOption in degreePrograms[degreeName].option) {
						degreeOptions.append($("<li>", {
							value: degreeOption,
						}).append($("<label>", {
							text: degreeOption
						})).append($("<button>", {
							value: degreePrograms[degreeName].option[degreeOption],
							name: "modifyButton",
							text: "Modify"	
						})));
					} 
					$("#masters").append(degreeOptions);
				}
				$("button[name='modifyButton']").click(function(){
					$.ajax({
						type: "POST",
						url: "../scripts/requirements.php",
						data: {idObjects: $(this).val()},
						dataType: "json",
						success: function(json) {
							popupHandler(json);
						}
					});
				});
			}

			function popupHandler(json){
				catalogRule = json;
				catalogsLoaded = 0;
				catalogs = null;
				console.log(catalogRule);
				$("#classsublist").empty();
				var modal = document.getElementById('myModal');
				modal.style.display = "block";
				$("#requiredHr").attr('value',catalogRule["Degree Program"].requiredHours);
				$("#400hrs").attr('value',catalogRule["Degree Program"].hours400);
				$("#500hrs").attr('value',catalogRule["Degree Program"].hours500);
				$("#600hrs").attr('value',catalogRule["Degree Program"].hours600);
				$("#trhrs").attr('value',catalogRule["Degree Program"].transferCredit);
				$("#ohrs").attr('value',catalogRule["Degree Program"].outsideCredit);
				$("#grade").attr('value',catalogRule["Degree Program"].minGrade);
				for(var i in catalogRule["Catalogs"]){
					let catalogName = catalogRule["Catalogs"][i];
					$.ajax({
						type: "POST",
						url: "../scripts/courseCatalog.php",
						data: {catalogName: catalogName},
						dataType: "json",
						success: function(json) {
							courseHandler(json, catalogName);
						}
					});
				}
			}

			function courseHandler(catalogArray, catalogName){
				if(!catalogs) {
					catalogs = catalogArray;
				} else {
				 	for(var i in catalogArray) {
						catalogs[i] = catalogArray[i];
					}
				}
				catalogsLoaded++;
			
				var $courseList = $("<select>", {
					id: "courseList"
				});
				for(var i in catalogArray) {
					$courseList.append($("<option>",{
						value: catalogArray[i].name,
						text: catalogArray[i].prefix + " " + catalogArray[i].number + " : " +  catalogArray[i].name
					}));
				}
				$catalogs[catalogName] = $courseList;
			
				if(catalogsLoaded === catalogRule["Catalogs"].length) {
					
					//Iterate through catalog index with degreeID
					for(var i in catalogRule["Degree Program"].requiredCourses){
						$("#classsublist").append($("<li>",{
							text: catalogs[i].name
						}).append($("<input>",{
							type: "submit",
							name: "removeClassButton",
							id: i,
							value: "Remove"
						})));
					}
					console.log($catalogs);
					addClassHandler();
				}
			}

			function closepopup(){	
				$("#classsublist").empty();
				$("#addedClass").remove();
				var modal = document.getElementById('myModal');
				modal.style.display = "none";	
			}

			function addClassHandler(){
				$("#catalogList").empty();
				$("#classList").empty();
				for(var i in catalogRule["Catalogs"]){
					$("#catalogList").append($("<option>",{
						value: catalogRule["Catalogs"][i],
						text: catalogRule["Catalogs"][i]
					}));
				}
				
				$catalogs[catalogRule["Catalogs"][0]].insertAfter($("#classListLabel"));
			}
        </script>
        <style>

        </style>
    </head>
    <body>
        <div>
            <h4>Masters</h4>
            <ul id="masters">
		
            </ul>
		</div>
		<div id="myModal" class="modal">
			<div class="modal-content">
			  <span onclick="closepopup()" class="close">&times;</span>
			  <div id="popupform">
					Required Hours: <input type="number" id="requiredHrs">
					400 Hours: <input type="number" id="400hrs">
					500 Hours: <input type="number" id="500hrs">
					600 Hours: <input type="number" ud="600hrs">
					Transfer Credit Hours: <input type="number" id="trhrs">
					Outside Credit Hours: <input type="number" id="ohrs">
					Minimum Grade:: <input type="text" id="grade">
			  </div>
			  <input type="submit" id="submitChange" value="Submit Change" />
			  <div id="requiredClasses">
				<h2>Required Courses</h2>
				<ul id="classsublist">

				</ul>
			  </div>
			  Catalog: <select id="catalogList"></select><label for="classList" id="classListLabel">Class:</label><input type="button" id="addClassButton" value="Add Class"/>
			</div>
		</div>
    </body>
</html>
