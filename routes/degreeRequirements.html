<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf8">
        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
		<script type="text/javascript" src="../scripts/CookieParser.js"></script>
		<script type="text/javascript" src="../scripts/CourseObserver.js"></script>
		<script type="text/javascript" src="../scripts/Requirements.js"></script>
        <script>
			var courseCatalog;
			var selectedCourses = [];
			var courseObserver = new CourseObserver();
			
            $(document).ready(function(){
				
				displayUserInfo();
				
				$("#candidacyForm").click(function(event) {
					
					var data = [];
					var courseCounter = 1;
					data["FirstName"] = getCookie("firstName");
					data["LastName"] = getCookie("lastName");
					data["MiddleName"] = getCookie("middleName");
					data["Email"] = getCookie("email");
					data["StudentID"] = getCookie("studentID");
					data["Major"] = getCookie("program");
					data["ThesisType"] = getCookie("option");
					$("#courseTableBody tr.courseEntry").each(function() {
						var courseId = $(this).attr("id");
						data["MajorGrade" + courseCounter] = $(this).find("#grade").text();
						data["MajorCourseHours" + courseCounter] = $(this).find("#hours").text();
						data["MajorCourseYear" + courseCounter] = $(this).find("#year").text() + "/" + $(this).find("#term").text();
						data["MajorCourseNamePrefix" + courseCounter] = courseCatalog[courseId].prefix;
						data["MajorCourseNumber" + courseCounter] = courseCatalog[courseId].number;
						data["MajorCourseTitle" + (courseCounter++)] = courseCatalog[courseId].name;
					});
					createForm(data).submit();
				}); 			
				
				$.ajax({
					type: "POST",
					url: "../scripts/courseCatalog.php",
					data: {catalogName: getCookie("program") },
					dataType: "json",
					success: function(json) {
						courseHandler(json);
					}
				});
								

				
				$("#addCourse").click(function() {
					$("#courseMenu").show();
				});
				
				$("#submitCourse").click(function(event) {
					event.preventDefault();
					if(!$("#grade")[0].checkValidity()){
						alert("Grade is invalid");
						return false;
					}
					if(!$("#year")[0].checkValidity()) {
						alert("Year is invalid");
						return false;
					}
					if(!$("#hours")[0].checkValidity()) {
						alert("Hours is invalid");
						return false;
					}
					var selectedCourse = $("#courseList option:selected").val();
					var closeButton = $("<button/>", {
						text: "X"
					});
					if(!selectedCourses.includes(selectedCourse)){
						selectedCourses.push(selectedCourse);
						courseObserver.broadcast(selectedCourse, parseInt($("#hours").val()), courseCatalog[selectedCourse].number);
						
						var $row = $("<tr>", {
							class: "courseEntry",
							id: $("#courseList option:selected").val()
						});
						$row.append($("<td>", {
							id: "courseNumber",
							text: $("#courseList option:selected").text()
						})).append($("<td>", {
							id: "grade",
							text: $("#grade").val()
						})).append($("<td>", {
							id: "year",
							text: $("#year").val()
						})).append($("<td>", {
							id: "term",
							text: $("#term option:selected").val()
						})).append($("<td>", {
							id: "hours",
							text: $("#hours").val()
						}));
						$("#courseTableBody").append($row);
					}
					$("#grade").val("");
					$("#year").val("");
					$("#courseMenu").hide();
				});
				
            });
            
			function displayUserInfo() {
				console.log("Cookie is " + getCookie("option"));
				$("#option").text(getCookie("option"));
				$("#program").text(getCookie("program"));
			}
			
			function createForm(data) {
				var form = document.createElement("form");
				document.body.appendChild(form);
				form.action = "../scripts/generateForm.php";
				form.method = "POST";
				for(var name in data) {
					var input = document.createElement("input");
					input.type = "hidden";
					input.name = name;
					input.value = data[name];
					form.appendChild(input);
				}
				return form;
			};
			
			function setCourseHours(courseId) {
				if(courseCatalog[courseId].lowHours != courseCatalog[courseId].highHours) {
					$("#hours").val("");
					$("#hours").attr("placeholder", courseCatalog[courseId].lowHours + "-" + courseCatalog[courseId].highHours); 
				} else {
					$("#hours").val(courseCatalog[courseId].lowHours);
				}
				
			}
			
            function courseHandler(json) {
                courseCatalog = json;
				console.log(courseCatalog);
                for(var i in courseCatalog) {
                    $("#courseList").append($("<option>", {
                        value: i,
                        text: courseCatalog[i].prefix + " " + courseCatalog[i].number
                    })); 
                }
				
				var xhr = new XMLHttpRequest();
				xhr.addEventListener("load", requirementsHandler);
				xhr.open("GET", "../scripts/requirements.php");
				xhr.send();
				
				setCourseHours($("#courseList option:selected").val());

				$("#courseList").change(function() {
					setCourseHours($(this).val());
				});

            };

			function requirementsHandler() {
				console.log(this.response);
				var requirements = JSON.parse(this.response);
				console.log(requirements);
				var requiredList = $("#requiredCourses");
				var requirement = new Requirements();
				if(requirements["Degree Program"].requiredHours !== undefined) {
					var $progressBar = $("#requiredHoursProgress");
					$progressBar.attr("max", requirements["Degree Program"].requiredHours.toString());
					requirement.setRequiredHours(requirements["Degree Program"].requiredHours, degreeHoursEvent.bind($progressBar));
				}
				if(requirements["Degree Program"].hours400) {
					requirement.set400LevelHours(requirements["Degree Program"].hours400, function() { alert("Maximum 400 level hours exceeded"); });
				}
				if(requirements["Degree Program"].hours500) {
					requirement.set500LevelHours(requirements["Degree Program"].hours500, function() { alert("Maximum 500 level hours exceeded"); });
				}
				// TODO Add database support for 600 level hours 
				/* Load in the required courses and substitutable courses for the degree program. Start by looking at requiredCourses array */
				for(var i in requirements["Degree Program"].requiredCourses) {
					
					console.log(i);
					console.log(courseCatalog[i]);
					
					/* For display purposes, add a string detailing the hour range for any course that is variable hours and append the item to the list */
					if(courseCatalog[i].lowHours != courseCatalog[i].highHours) {
						var hourString = courseCatalog[i].lowHours + " - " + courseCatalog[i].highHours;
					} else {
						var hourString = courseCatalog[i].highHours;
					}
					var $courseItem = $("<li>", {
						value: i,
						text: courseCatalog[i].prefix + " " + courseCatalog[i].number + " " + courseCatalog[i].name + " hours " + hourString
					});
					requiredList.append($courseItem);
					requirement.addRequiredCourse(i, degreeCourseEvent.bind($courseItem)); // Add the courseId of the required course to the requirements object
					
					/* Check to see if any of the courses have substitutions that may be taken in place of required course */
					if(requirements["Degree Program"].requiredCourses[i].length > 0) {
						/* Create a sublist for the substitutable courses, create list items for sub courses and append sublist to required course list item */
						var substitutableCourses = $("<ul id='sublist'>");
						for(var y = 0; y < requirements["Degree Program"].requiredCourses[i].length; y++) {
							var courseId = requirements["Degree Program"].requiredCourses[i][y];

							if(courseCatalog[i].lowHours != courseCatalog[i].highHours) {
								var hourString = courseCatalog[courseId].lowHours + " - " + courseCatalog[courseId].highHours;
							} else {
								var hourString = courseCatalog[courseId].highHours;
							}
							var $courseItem = $("<li>", {
								value: courseCatalog[courseId],
								text: courseCatalog[courseId].prefix + " " + courseCatalog[courseId].number + " " + courseCatalog[courseId].name + " hours " + hourString
							});
							substitutableCourses.append($courseItem);
							requirement.addRequiredCourse(courseId, degreeCourseEvent.bind($courseItem));
							requirement.setSubstitutableCourses(i, courseId);
						}
						requiredList.append(substitutableCourses);
					}
				}
				requirement.setFufilledOperation(function() {
					$("#candidacyForm").removeAttr("disabled");
				});
				courseObserver.subscribe(requirement.addCourse.bind(requirement));
				
				certificateRequirementsHandler(requirements["Certificate"]);
			}
			
			function degreeHoursEvent(addedHours) {
				console.log("inside degree hours event");
				$(this).val($(this).val() + addedHours);
			}
			
			function degreeCourseEvent() {
				$(this).attr("style", "color:green");
			}
			
			function certificateCourseEvent() {
				$(this).attr("style", "color:green");
			}
			
			function certificateRequirementsHandler(certificates) {
				if(certificates.length > 0) {
					$("#certificateContainer").show();
				}
				var $certificateEntry = $("#certificateList");
				certificates.forEach(function(certificate) {
					var requirement = new Requirements();

					$certificateEntry.append($("<li>", {
						text: certificate.name
					}));
					
					var $courseList = $("<ul>", {
						class: "certificateCourseList"
					});
					
					for(var i in certificate.requiredCourses) {
						var $courseItem = $("<li>", {
							text: courseCatalog[i].prefix + " " + courseCatalog[i].number
						});
						$courseList.append($courseItem);
						requirement.addRequiredCourse(i, certificateCourseEvent.bind($courseItem)); 
						
						/* Check to see if any of the courses have substitutions that may be taken in place of required course */
						if(certificate.requiredCourses[i].length > 0) {
							var $certificateSubEntry = $("<ul>", {
								class: "certificateCourses"
							});
							for(var y = 0; y < certificate.requiredCourses[i].length; y++) {
								var courseId = certificate.requiredCourses[i][y];

								requirement.setSubstitutableCourses(i, courseId);
								var $courseItem = $("<li>", {
									text: courseCatalog[courseId].prefix + " " + courseCatalog[courseId].number
								});	
								requirement.addRequiredCourse(courseId, certificateCourseEvent.bind($courseItem));
								$certificateSubEntry.append($courseItem);
							}
							$courseList.append($certificateSubEntry);
						}
					}
					$certificateEntry.append($courseList);
					$("#certificateContainer").append($certificateEntry);
					requirement.setFufilledOperation(function() {
						alert(certificate.name + " earned");
					});
					courseObserver.subscribe(requirement.addCourse.bind(requirement));
				});
			}
        </script>
    </head>
    <body>
		<div>
			<p>Program: <span id="program"></span> <span id="option"></span></p>
			<h3>Required Hours</h3>
			<progress id="requiredHoursProgress" value="0" max="0"></progress>
			<h2>Required Courses</h2>
			<ul id="requiredCourses">

			</ul>
		</div>
		<button id="addCourse" type="button">Add Course</button>
		<br>
		<br>
		<div>
			<form id="courseMenu" hidden>
				<select id="courseList">
            
				</select>
				<label for="grade">Grade</label><input type="text" id="grade" name="grade" size="1" maxlength="1" pattern="[ABCDF]{1}" required></input>
				<label for="year">Year</label><input type="number" id="year" style="width:50px" required></input>
				<label for="term">Term</label>
				<select id="term">
					<option id="fall" value="Fall">Fall</option>
					<option id="spring" value="Spring">Spring</option>
					<option id="summer" value="Summer">Summer</option>
				</select>
				<label for="hours">Hours</label><input type="number" id="hours" name="hours" style="width:50px" required></input>
				<input id="submitCourse" type="submit"></input>
			</form>
		</div>
		<div>
			<table id="courseTable">
				<tbody id="courseTableBody">
					<tr>
						<th>Course</th>
						<th>Grade</th>
						<th>Year</th>
						<th>Term</th>
						<th>Hours</th>
					</tr>
				</tbody>
			</table>
		</div>
		<button id="candidacyForm" type="button" disabled>Admission To Candidacy</button>
		<div id="certificateContainer" hidden>
			<h2>Certificates</h2>
			<ul id="certificateList">
			</ul>
		</div>
    </body>
</html>
